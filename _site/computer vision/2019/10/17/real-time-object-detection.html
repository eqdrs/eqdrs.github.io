<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <title>Detecção de Objetos em Tempo Real usando a API TensorFlow Object Detection</title>
    <meta name="description" content="Everton Quadros personal website." />

    <meta name="HandheldFriendly" content="True" />
    <meta name="MobileOptimized" content="320" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <!-- Customisation  -->
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css" />
    <link rel="shortcut icon" type="image/png" href="/assets/images/favicon.png">

</head>
<body class="home-template">

    <header class="main-header post-head no-cover">
    <nav class="main-nav  clearfix">
        <a class="back-button icon-arrow-left" href="http://localhost:4000">Home</a>
        <a class="subscribe-button icon-feed" href="http://localhost:4000feed.xml">Subscribe</a>
    </nav>
</header>

<main class="content" role="main">

    <article class="post">

        <header class="post-header">
            <h1 class="post-title">Detecção de Objetos em Tempo Real usando a API TensorFlow Object Detection</h1>
            <section class="post-meta">
                <time class="post-date" datetime="2019-10-17">17 Oct 2019</time>
                
                    on Computer Vision
                
            </section>
        </header>

<!--         <header class="post-header">
            <a id="blog-logo" href="http://localhost:4000">
                
                    <img src="/assets/images/profile2.jpeg" alt="Everton Quadros" />
                
            </a>
        </header> -->

        <!-- <span class="post-meta">
            <time datetime="2019-10-17">17 Oct 2019</time>
            
                on Computer Vision
            
        </span> -->

        <!-- <h1 class="post-title">Detecção de Objetos em Tempo Real usando a API TensorFlow Object Detection</h1> -->

        <section class="post-content">
            <p>Olá, pessoal! Neste post, irei trazer uma pequena experiência usando a Tensorflow Object Detection API. Trata-se de uma aplicação em Python para detecção de objetos em tempo real, que utiliza esta API como backend. É necessário ter uma webcam no seu computador para executar o projeto.</p>

<p>A <a href="https://tensorflow-object-detection-api-tutorial.readthedocs.io/en/latest/">TensorFlow Object Detection API</a> é uma estrutura de código aberto construída sobre o TensorFlow, que facilita a construção, treinamento e implantação de modelos de detecção de objetos.</p>

<p>Para a aplicação, usaremos um modelo pré-treinado oferecido pela API, o <strong>SSD MobileNet v1 (COCO)</strong>, que possui velocidade rápida (30 ms) e um índice de precisão de 21%.</p>

<h5 id="ssd--single-shot-multibox-detector">SSD – Single Shot MultiBox Detector</h5>
<p></p>

<p>O Single Shot MultiBox Detector é um método para detecção objetos em imagens que usa uma única rede neural profunda. Ele difere de outros detectores de single shot devido ao uso de múltiplas camadas que proporcionam uma precisão mais fina em objetos com diferentes escalas (cada camada mais profunda verá objetos maiores). Aqui você encontra o paper original: <a href="https://arxiv.org/pdf/1512.02325.pdf">https://arxiv.org/pdf/1512.02325.pdf</a>.</p>

<p>O SSD normalmente começa com um modelo pré-treinado que é convertido em uma rede neural totalmente convolutiva. Em seguida, são anexadas algumas camadas de convolução extras, que ajudarão a detectar objetos maiores na imagem.</p>

<p>O termo “Multibox” se refere à etapa anterior ao Single Shot Detector, dentro da arquitetura do SSD. Ele divide a imagem em diversos segmentos, e desenha caixas delimitadoras em torno de cada um desses segmentos. Feito isso, o algoritmo verifica onde existe um objeto a ser detectado dentro dessas caixas (durante o processo de construção do modelo, nós informamos quais são as possíveis classes a serem detectadas).</p>

<p><img src="/assets/images/multibox.png" alt="multibox" /></p>

<h5 id="entendendo-o-código-da-aplicação">Entendendo o código da aplicação</h5>
<p></p>

<p>A aplicação irá iniciar a webcam e então iniciar a captura das imagens em vídeo. Cada frame do vídeo é processado como uma imagem, que recebe algumas tarefas de pré-processamento. Uma vez que a imagem tenha sido processada, ela é entregue ao modelo de aprendizagem de máquina fornecido pela API do TensorFlow, que então classifica a imagem e mostra o score, que é o percentual de certeza sobre a classificação.</p>

<p>Você pode baixar/clonar o código da aplicação <a href="https://github.com/eqdrs/object-detection-app">clicando aqui</a>. Abaixo, a implementação do <code class="highlighter-rouge">object_detection_app.py</code> com alguns comentários.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
</pre></td><td class="code"><pre><span class="c1"># object_detection_app.py
</span>
<span class="c1"># Imports
</span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="n">tf</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="n">slim</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">contrib</span><span class="o">.</span><span class="n">slim</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.image</span> <span class="k">as</span> <span class="n">mpimg</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">'../'</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">nets</span> <span class="kn">import</span> <span class="n">ssd_vgg_300</span><span class="p">,</span> <span class="n">ssd_common</span><span class="p">,</span> <span class="n">np_methods</span>
<span class="kn">from</span> <span class="nn">preprocessing</span> <span class="kn">import</span> <span class="n">ssd_vgg_preprocessing</span>
<span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">visualization</span>

<span class="c1"># Sessão TensorFlow: aumenta a memória quando necessário. 
</span><span class="n">gpu_options</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">GPUOptions</span><span class="p">(</span><span class="n">allow_growth</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">ConfigProto</span><span class="p">(</span><span class="n">log_device_placement</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">gpu_options</span><span class="o">=</span><span class="n">gpu_options</span><span class="p">)</span>
<span class="n">isess</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">InteractiveSession</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

<span class="c1"># Placeholders de Input
</span><span class="n">net_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
<span class="n">data_format</span> <span class="o">=</span> <span class="s">'NHWC'</span>
<span class="n">img_input</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

<span class="c1"># Pré-processamento: resize para. shape do SSD
</span><span class="n">image_pre</span><span class="p">,</span> <span class="n">labels_pre</span><span class="p">,</span> <span class="n">bboxes_pre</span><span class="p">,</span> <span class="n">bbox_img</span> <span class="o">=</span> <span class="n">ssd_vgg_preprocessing</span><span class="o">.</span><span class="n">preprocess_for_eval</span><span class="p">(</span>
    <span class="n">img_input</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">net_shape</span><span class="p">,</span> <span class="n">data_format</span><span class="p">,</span> <span class="n">resize</span><span class="o">=</span><span class="n">ssd_vgg_preprocessing</span><span class="o">.</span><span class="n">Resize</span><span class="o">.</span><span class="n">WARP_RESIZE</span><span class="p">)</span>
<span class="n">image_4d</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">image_pre</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># Define o modelo SSD
</span><span class="n">reuse</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="s">'ssd_net'</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="k">else</span> <span class="bp">None</span>
<span class="n">ssd_net</span> <span class="o">=</span> <span class="n">ssd_vgg_300</span><span class="o">.</span><span class="n">SSDNet</span><span class="p">()</span>
<span class="k">with</span> <span class="n">slim</span><span class="o">.</span><span class="n">arg_scope</span><span class="p">(</span><span class="n">ssd_net</span><span class="o">.</span><span class="n">arg_scope</span><span class="p">(</span><span class="n">data_format</span><span class="o">=</span><span class="n">data_format</span><span class="p">)):</span>
    <span class="n">predictions</span><span class="p">,</span> <span class="n">localisations</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ssd_net</span><span class="o">.</span><span class="n">net</span><span class="p">(</span><span class="n">image_4d</span><span class="p">,</span> <span class="n">is_training</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="n">reuse</span><span class="p">)</span>

<span class="c1"># Restaura o modelo SSD
</span><span class="n">ckpt_filename</span> <span class="o">=</span> <span class="s">'checkpoints/ssd_300_vgg.ckpt'</span>
<span class="n">isess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">())</span>
<span class="n">saver</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Saver</span><span class="p">()</span>
<span class="n">saver</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">isess</span><span class="p">,</span> <span class="n">ckpt_filename</span><span class="p">)</span>

<span class="c1"># SSD default anchor boxes
</span><span class="n">ssd_anchors</span> <span class="o">=</span> <span class="n">ssd_net</span><span class="o">.</span><span class="n">anchors</span><span class="p">(</span><span class="n">net_shape</span><span class="p">)</span>

<span class="c1"># Rotina de processamento das imagens
</span><span class="k">def</span> <span class="nf">process_image</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">select_threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">nms_threshold</span><span class="o">=</span><span class="mf">.45</span><span class="p">,</span> <span class="n">net_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="p">)):</span>

    <span class="c1"># Executa a rede SSD.
</span>    <span class="n">rimg</span><span class="p">,</span> <span class="n">rpredictions</span><span class="p">,</span> <span class="n">rlocalisations</span><span class="p">,</span> <span class="n">rbbox_img</span> <span class="o">=</span> <span class="n">isess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">image_4d</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">localisations</span><span class="p">,</span> <span class="n">bbox_img</span><span class="p">],</span>
                                                              <span class="n">feed_dict</span><span class="o">=</span><span class="p">{</span><span class="n">img_input</span><span class="p">:</span> <span class="n">img</span><span class="p">})</span>
    
    <span class="c1"># Obtém classes e bboxes (bounding boxes) das saídas da rede
</span>    <span class="n">rclasses</span><span class="p">,</span> <span class="n">rscores</span><span class="p">,</span> <span class="n">rbboxes</span> <span class="o">=</span> <span class="n">np_methods</span><span class="o">.</span><span class="n">ssd_bboxes_select</span><span class="p">(</span>
            <span class="n">rpredictions</span><span class="p">,</span> <span class="n">rlocalisations</span><span class="p">,</span> <span class="n">ssd_anchors</span><span class="p">,</span>
            <span class="n">select_threshold</span><span class="o">=</span><span class="n">select_threshold</span><span class="p">,</span> <span class="n">img_shape</span><span class="o">=</span><span class="n">net_shape</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">decode</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
    <span class="n">rbboxes</span> <span class="o">=</span> <span class="n">np_methods</span><span class="o">.</span><span class="n">bboxes_clip</span><span class="p">(</span><span class="n">rbbox_img</span><span class="p">,</span> <span class="n">rbboxes</span><span class="p">)</span>
    <span class="n">rclasses</span><span class="p">,</span> <span class="n">rscores</span><span class="p">,</span> <span class="n">rbboxes</span> <span class="o">=</span> <span class="n">np_methods</span><span class="o">.</span><span class="n">bboxes_sort</span><span class="p">(</span><span class="n">rclasses</span><span class="p">,</span> <span class="n">rscores</span><span class="p">,</span> <span class="n">rbboxes</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
    <span class="n">rclasses</span><span class="p">,</span> <span class="n">rscores</span><span class="p">,</span> <span class="n">rbboxes</span> <span class="o">=</span> <span class="n">np_methods</span><span class="o">.</span><span class="n">bboxes_nms</span><span class="p">(</span><span class="n">rclasses</span><span class="p">,</span> <span class="n">rscores</span><span class="p">,</span> <span class="n">rbboxes</span><span class="p">,</span> <span class="n">nms_threshold</span><span class="o">=</span><span class="n">nms_threshold</span><span class="p">)</span>
    
    <span class="c1"># Redimensiona bboxes para a forma original da imagem. 
</span>    <span class="n">rbboxes</span> <span class="o">=</span> <span class="n">np_methods</span><span class="o">.</span><span class="n">bboxes_resize</span><span class="p">(</span><span class="n">rbbox_img</span><span class="p">,</span> <span class="n">rbboxes</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rclasses</span><span class="p">,</span> <span class="n">rscores</span><span class="p">,</span> <span class="n">rbboxes</span>


<span class="c1"># Testa nas imagens de teste
</span><span class="n">path</span> <span class="o">=</span> <span class="s">'demo/'</span>
<span class="n">image_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>

<span class="c1"># Altera o valor de 1 a 7 para testar diferentes imagens
</span><span class="n">img</span> <span class="o">=</span> <span class="n">mpimg</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">image_names</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>
<span class="n">rclasses</span><span class="p">,</span> <span class="n">rscores</span><span class="p">,</span> <span class="n">rbboxes</span> <span class="o">=</span>  <span class="n">process_image</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

<span class="c1"># Visualiza a imagem com os objetos detectados
</span><span class="n">visualization</span><span class="o">.</span><span class="n">plt_bboxes</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">rclasses</span><span class="p">,</span> <span class="n">rscores</span><span class="p">,</span> <span class="n">rbboxes</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h5 id="executando-a-aplicação">Executando a aplicação</h5>
<p></p>

<p>Os requisitos e instruções de uso estão disponíveis no arquivo <code class="highlighter-rouge">README.md</code> do projeto. Basicamente, será necessário ter o Anaconda instalado, com uma versão do Python igual ou superior a <code class="highlighter-rouge">3.6.5</code>, além do OpenCV e TensorFlow.</p>

<p>Abaixo, um vídeo demonstrando um pouco da aplicação em funcionamento:</p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/u9znvuGpVfk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>

<p>Muito bacana, né?! Pretendo trazer para o blog mais posts relacionados a Visão Computacional, dessa vez mostrando como criar nossos próprios modelos. É uma das áreas de IA que mais me chamam atenção.</p>

<p>Espero que tenham gostado! Até mais, pessoal! 😊</p>


        </section>

        

        <footer class="post-footer">
            <!-- If we want to display author's name and bio -->
            
                <figure class="author-image">
                    <a class="img" href="/about" style="background-image: url(/assets/images/profile.jpeg)">
                    <span class="hidden">Everton Quadros's Picture</span></a>
                </figure>
                <section class="author">
                    <!-- Author Name -->
                    <h4> <a class="img" href="/about" style="background-image: url(/assets/images/profile.jpeg)">
                    <span class="hidden">Everton Quadros's Picture</span><a class="img" href="/about" style="background-image: url(/assets/images/profile.jpeg)">
                    <span class="hidden">Everton Quadros's Picture</span><a href="/about">Everton Quadros</a></h4>
                    <!-- Author Bio -->
                    <p>
                        Desenvolvedor e estudante de Engenharia da Computação. Apaixonado por tecnologia!
                    </p>
                </section>
            

            <!-- Share links section -->
            <section class="share">
    <h4>Compartilhe</h4>
    <a class="icon-twitter" href="http://twitter.com/share?text=Detecção de Objetos em Tempo Real usando a API TensorFlow Object Detection&amp;url=https://eqdrs.github.io//computer%20vision/2019/10/17/real-time-object-detection.html"
        onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://eqdrs.github.io//computer%20vision/2019/10/17/real-time-object-detection.html"
        onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <span class="hidden">Facebook</span>
    </a>
    <a class="icon-google-plus" href="https://plus.google.com/share?url=https://eqdrs.github.io//computer%20vision/2019/10/17/real-time-object-detection.html"
       onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <span class="hidden">Google+</span>
    </a>
</section>

            <!-- Disqus comments -->
            

        </footer>

    </article>

</main>

    <footer class="site-footer clearfix">
      <section class="copyright">
        <a href="/">Everton Quadros</a> &copy; 
              2019 &bull; All rights reserved.
      </section>
    </footer>
    
    <script type="text/javascript" src="/assets/js/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/assets/js/index.js"></script>

    <!-- Google Analytics Tracking code -->
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-146875310-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
    
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-146875310-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
